<section class="student-subjects">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Mis Materias</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      @if(enrolledSubjects.length > 0){
      <div class="enrolled-subjects">
        @for(enrollment of enrolledSubjects; track $index){
        <app-card
          [cardTitle]="
            enrollment.mid_comission_subject?.subject?.subject_name ||
            'Sin nombre'
          "
          [cardSubtitle]="
            'Comisión: ' +
            (enrollment.mid_comission_subject?.comission?.comission_name ||
              'N/A')
          "
          [cardPercentageLabel]="'Porcentaje de asistencias'"
          [cardPercentage]="enrollment.attendance_percentage || 0"
          [cardDateLabel]="'Estado'"
          [cardDate]="enrollment.enrollment_status || 'ACTIVO'"
          [enrollmentId]="enrollment.id"
        >
        </app-card>
        }
      </div>
      } @else {
      <div class="empty-state">
        <mat-icon>school</mat-icon>
        <p>Aún no estás inscrito en ninguna materia.</p>
        <p>Utiliza el formulario de la derecha para inscribirte.</p>
      </div>
      }
    </mat-card-content>
  </mat-card>

  <aside>
    <mat-card>
      <mat-card-header>
        <mat-card-title>Inscripción a Materias</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="enrollment-form">
          <mat-form-field appearance="outline">
            <mat-label>Selecciona tu carrera</mat-label>
            <mat-select
              [(value)]="selectedDegree"
              (selectionChange)="onDegreeChange($event.value)"
            >
              <mat-option *ngFor="let degree of degrees" [value]="degree.id">
                {{ degree.degree_name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" *ngIf="selectedDegree">
            <mat-label>Selecciona tu comisión</mat-label>
            <mat-select
              [(value)]="selectedComission"
              (selectionChange)="onComissionChange($event.value)"
            >
              @for(comission of comissions; track $index){
              <mat-option [value]="comission.id">
                Comisión {{ comission.comission_name }} -
                {{ comission.comission_year }}
              </mat-option>
              }
            </mat-select>
          </mat-form-field>

          @if(selectedComission && availableSubjects.length > 0){
          <div class="subjects-list">
            <h3>Materias disponibles:</h3>
            <mat-list>
              @for(midComSubject of availableSubjects; track $index){
              <mat-list-item>
                <div matListItemTitle>
                  {{ midComSubject.subject.subject_name }}
                </div>
                <div matListItemLine>
                  Año: {{ midComSubject.subject.subject_year }}
                </div>
                <button
                  matButton="tonal"
                  (click)="enrollSubject(midComSubject.id)"
                  [disabled]="isEnrolled(midComSubject.id)"
                >
                  {{
                    isEnrolled(midComSubject.id) ? "Inscrito" : "Inscribirse"
                  }}
                </button>
              </mat-list-item>
              }
            </mat-list>
          </div>
          } @else if(selectedComission && availableSubjects.length === 0){
          <p class="no-subjects">
            No hay materias disponibles en esta comisión.
          </p>
          } @else if(!selectedDegree) {
          <p class="hint">Selecciona una carrera para comenzar.</p>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>Información</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <mat-list>
          <mat-list-item>
            <span matListItemTitle>Carrera seleccionada:</span>
            <span matListItemLine>{{
              getDegreeName(selectedDegree) || "Ninguna"
            }}</span>
          </mat-list-item>

          <mat-list-item>
            <span matListItemTitle>Comisión:</span>
            <span matListItemLine>{{
              getComissionName(selectedComission) || "Ninguna"
            }}</span>
          </mat-list-item>

          <mat-list-item>
            <span matListItemTitle>Materias inscritas:</span>
            <span matListItemLine>{{ enrolledSubjects.length }}</span>
          </mat-list-item>
        </mat-list>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>Tabla de Referencias</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <mat-list>
          <mat-list-item>
            <mat-icon matListItemIcon>check_circle</mat-icon>
            <div matListItemTitle>Promocional</div>
          </mat-list-item>

          <mat-list-item>
            <mat-icon matListItemIcon>schedule</mat-icon>
            <div matListItemTitle>Regular</div>
          </mat-list-item>

          <mat-list-item>
            <mat-icon matListItemIcon>block</mat-icon>
            <div matListItemTitle>Libre</div>
          </mat-list-item>
        </mat-list>
      </mat-card-content>
    </mat-card>
  </aside>
</section>
