<section class="teacher-subjects">
  <main class="teacher-subjects__content">
    <div class="page-header">
      <h1>Materias</h1>
      <h5>Asígnate materias y toma asistencias.</h5>
    </div>

    <mat-tab-group>
      <mat-tab label="Mis Materias">
        <div class="tab-content">
          @if(assignedSubjects.length > 0){
          <div class="assigned-subjects">
            @for(degreeGroup of groupedAssignments; track degreeGroup.degreeId){
            <div class="degree-group">
              <h2 class="degree-title">
                {{ degreeGroup.degreeName }}
                <mat-chip disabled class="m-1">{{
                  degreeGroup.assignments.length
                }}</mat-chip>
              </h2>
              <div class="degree-subjects">
                @for(assignment of degreeGroup.assignments; track
                assignment.id){
                <app-card
                  [cardTitle]="
                    assignment.mid_comission_subject?.subject?.subject_name ||
                    'Sin nombre'
                  "
                  [cardSubtitle]="
                    'Comisión: ' +
                    (assignment.mid_comission_subject?.comission
                      ?.comission_name || 'N/A')
                  "
                  [cardPercentageLabel]="'Año de la materia'"
                  [cardPercentage]="
                    assignment.mid_comission_subject?.subject?.subject_year || 0
                  "
                  [cardDateLabel]="'Tipo de asignación'"
                  [cardDate]="assignment.assign_type || 'DICTA'"
                  [midComissionSubjectId]="
                    assignment.mid_comissions_subjects_id
                  "
                >
                </app-card>
                }
              </div>
            </div>
            }
          </div>
          } @else {
          <app-empty-state
            [icon]="'school'"
            [text]="'Aún no tienes materias asignadas.'"
          ></app-empty-state>
          }
        </div>
      </mat-tab>

      <mat-tab label="Asignación">
        <div class="tab-content">
          <div class="assignment-section">
            <mat-card class="assignment-main-card">
              <mat-card-content>
                <div class="assignment-form">
                  <mat-form-field appearance="outline">
                    <mat-label>Selecciona la carrera</mat-label>
                    <mat-select
                      [(value)]="selectedDegree"
                      (selectionChange)="onDegreeChange($event.value)"
                    >
                      <mat-option
                        *ngFor="let degree of degrees"
                        [value]="degree.id"
                      >
                        {{ degree.degree_name }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="selectedDegree">
                    <mat-label>Selecciona la comisión</mat-label>
                    <mat-select
                      [(value)]="selectedComission"
                      (selectionChange)="onComissionChange($event.value)"
                    >
                      @for(comission of comissions; track $index){
                      <mat-option [value]="comission.id">
                        Comisión {{ comission.comission_name }} -
                        {{ comission.comission_year }}
                      </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>

                  @if(selectedComission && availableSubjects.length > 0){
                  <div class="subjects-list">
                    <h3>Materias disponibles</h3>
                    <mat-list>
                      @for(midComSubject of availableSubjects; track $index){
                      <mat-list-item>
                        <div matListItemTitle>
                          {{ midComSubject.subject.subject_name }}
                        </div>
                        <div matListItemLine>
                          Año: {{ midComSubject.subject.subject_year }}
                        </div>
                        <button
                          matButton="filled"
                          (click)="assignSubject(midComSubject.id)"
                          [disabled]="isAssigned(midComSubject.id)"
                        >
                          {{
                            isAssigned(midComSubject.id)
                              ? "Asignado"
                              : "Asignarme"
                          }}
                        </button>
                      </mat-list-item>
                      }
                    </mat-list>
                  </div>
                  } @else if(selectedComission && availableSubjects.length ===
                  0){
                  <p class="no-subjects">
                    No hay materias disponibles en esta comisión.
                  </p>
                  } @else if(!selectedDegree) {
                  <p class="hint">Selecciona una carrera para comenzar.</p>
                  }
                </div>
              </mat-card-content>
            </mat-card>

            <aside class="assignment-info">
              <mat-card>
                <mat-card-header>
                  <mat-card-title>Información</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-list>
                    <mat-list-item>
                      <span matListItemTitle>Carrera seleccionada:</span>
                      <span matListItemLine>{{
                        getDegreeName(selectedDegree) || "Ninguna"
                      }}</span>
                    </mat-list-item>

                    <mat-list-item>
                      <span matListItemTitle>Comisión:</span>
                      <span matListItemLine>{{
                        getComissionName(selectedComission) || "Ninguna"
                      }}</span>
                    </mat-list-item>

                    <mat-list-item>
                      <span matListItemTitle>Materias asignadas:</span>
                      <span matListItemLine>{{ assignedSubjects.length }}</span>
                    </mat-list-item>
                  </mat-list>
                </mat-card-content>
              </mat-card>

              <mat-card>
                <mat-card-header>
                  <mat-card-title>Referencias</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-list>
                    <mat-list-item>
                      <mat-icon matListItemIcon>school</mat-icon>
                      <div matListItemTitle>DICTA</div>
                    </mat-list-item>

                    <mat-list-item>
                      <mat-icon matListItemIcon>assignment_ind</mat-icon>
                      <div matListItemTitle>PRECEPTOR</div>
                    </mat-list-item>

                    <mat-list-item>
                      <mat-icon matListItemIcon>person</mat-icon>
                      <div matListItemTitle>CURSA</div>
                    </mat-list-item>
                  </mat-list>
                </mat-card-content>
              </mat-card>
            </aside>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </main>
</section>
