<section class="student-subjects">
  <header class="subjects-header">
    <article class="flex items-center justify-center">
      <img
        src="assets/icons/arrow_left.svg"
        alt="Arrow left"
        class="invert"
        (click)="routerLinks.goToStudentDashboard()"
      />
      <h1 class="flex-1 text-center">Materias</h1>
    </article>
  </header>

  <main class="student-subjects__content">
    <mat-tab-group>
      <mat-tab label="Mis Materias">
        <div class="tab-content">
          @if(enrolledSubjects.length > 0){
          <div class="w-full">
            <mat-form-field
              appearance="fill"
              subscriptSizing="dynamic"
              class="search-field w-full search-section rounded-lg mb-5"
            >
              <mat-label>Buscar materias</mat-label>
              <input
                matInput
                [(ngModel)]="searchTerm"
                placeholder="Nombre, comisión o estado..."
                autocomplete="off"
                subscriptSizing="dynamic"
                class="rounded-lg"
              />
              <mat-icon matPrefix>search</mat-icon>
              @if(searchTerm) {
              <button
                mat-icon-button
                matSuffix
                (click)="clearSearch()"
                aria-label="Limpiar búsqueda"
              >
                <mat-icon>close</mat-icon>
              </button>
              }
            </mat-form-field>

            @if(searchTerm && totalEnrollments === 0) {
            <div class="no-results">
              <mat-icon>search_off</mat-icon>
              <p>No se encontraron materias con "{{ searchTerm }}"</p>
            </div>
            }
          </div>

          @if(filteredGroupedEnrollments.length > 0) {
          <div class="enrolled-subjects">
            @for(degreeGroup of filteredGroupedEnrollments; track
            degreeGroup.degreeId){
            <div class="degree-group">
              <h2 class="degree-title">
                {{ degreeGroup.degreeName }}
                <mat-chip disabled class="m-1">{{
                  degreeGroup.enrollments.length
                }}</mat-chip>
              </h2>
              <div class="degree-subjects">
                @for(enrollment of degreeGroup.enrollments; track
                enrollment.id){
                <app-card
                  [cardTitle]="
                    enrollment.mid_comission_subject?.subject?.subject_name ||
                    'Sin nombre'
                  "
                  [cardSubtitle]="
                    'Comisión: ' +
                    (enrollment.mid_comission_subject?.comission
                      ?.comission_name || 'N/A')
                  "
                  [cardPercentageLabel]="'Porcentaje de asistencias'"
                  [cardPercentage]="enrollment.attendance_percentage || 0"
                  [cardDateLabel]="'Estado'"
                  [cardDate]="enrollment.enrollment_status || 'ACTIVO'"
                  [enrollmentId]="enrollment.id"
                >
                </app-card>
                }
              </div>
            </div>
            }
          </div>
          } } @else {
          <div class="empty-state">
            <mat-icon>school</mat-icon>
            <p>Aún no estás inscrito en ninguna materia.</p>
            <p>Ve a la pestaña "Inscripción" para inscribirte.</p>
          </div>
          }
        </div>
      </mat-tab>

      <mat-tab label="Inscripción">
        <div class="tab-content">
          <div class="enrollment-section">
            <mat-card class="enrollment-main-card">
              <mat-card-content>
                <div class="enrollment-form">
                  <mat-form-field appearance="outline">
                    <mat-label>Selecciona tu carrera</mat-label>
                    <mat-select
                      [(value)]="selectedDegree"
                      (selectionChange)="onDegreeChange($event.value)"
                    >
                      <mat-option
                        *ngFor="let degree of degrees"
                        [value]="degree.id"
                      >
                        {{ degree.degree_name }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="selectedDegree">
                    <mat-label>Selecciona tu comisión</mat-label>
                    <mat-select
                      [(value)]="selectedComission"
                      (selectionChange)="onComissionChange($event.value)"
                    >
                      @for(comission of comissions; track $index){
                      <mat-option [value]="comission.id">
                        Comisión {{ comission.comission_name }} -
                        {{ comission.comission_year }}
                      </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>

                  @if(selectedComission && availableSubjects.length > 0){
                  <div class="subjects-list">
                    <h3>Materias disponibles</h3>
                    <div class="subjects-grid">
                      @for(midComSubject of availableSubjects; track $index){
                      <mat-card class="subject-card">
                        <mat-card-content>
                          <h4>{{ midComSubject.subject.subject_name }}</h4>
                          <p>Año: {{ midComSubject.subject.subject_year }}</p>
                          <button
                            matButton="filled"
                            (click)="enrollSubject(midComSubject.id)"
                            [disabled]="isEnrolled(midComSubject.id)"
                          >
                            {{
                              isEnrolled(midComSubject.id)
                                ? "Inscrito"
                                : "Inscribirse"
                            }}
                          </button>
                        </mat-card-content>
                      </mat-card>
                      }
                    </div>
                  </div>
                  } @else if(selectedComission && availableSubjects.length ===
                  0){
                  <p class="no-subjects">
                    No hay materias disponibles en esta comisión.
                  </p>
                  } @else if(!selectedDegree) {
                  <p class="hint">Selecciona una carrera para comenzar.</p>
                  }
                </div>
              </mat-card-content>
            </mat-card>

            <aside class="enrollment-info">
              <mat-card>
                <mat-card-header>
                  <mat-card-title>Información</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-list>
                    <mat-list-item>
                      <span matListItemTitle>Carrera seleccionada:</span>
                      <span matListItemLine>{{
                        getDegreeName(selectedDegree) || "Ninguna"
                      }}</span>
                    </mat-list-item>

                    <mat-list-item>
                      <span matListItemTitle>Comisión:</span>
                      <span matListItemLine>{{
                        getComissionName(selectedComission) || "Ninguna"
                      }}</span>
                    </mat-list-item>

                    <mat-list-item>
                      <span matListItemTitle>Materias inscritas:</span>
                      <span matListItemLine>{{ enrolledSubjects.length }}</span>
                    </mat-list-item>
                  </mat-list>
                </mat-card-content>
              </mat-card>

              <mat-card>
                <mat-card-header>
                  <mat-card-title>Referencias</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-list>
                    <mat-list-item>
                      <mat-icon matListItemIcon>check_circle</mat-icon>
                      <div matListItemTitle>Promocional</div>
                    </mat-list-item>

                    <mat-list-item>
                      <mat-icon matListItemIcon>schedule</mat-icon>
                      <div matListItemTitle>Regular</div>
                    </mat-list-item>

                    <mat-list-item>
                      <mat-icon matListItemIcon>block</mat-icon>
                      <div matListItemTitle>Libre</div>
                    </mat-list-item>
                  </mat-list>
                </mat-card-content>
              </mat-card>
            </aside>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </main>
</section>
